# Introdução  
A aula avança na prática do **Argo Rollouts** ao verificar a instalação dos CRDs, adaptar um **Deployment** existente para o tipo **Rollout** com estratégia **Blue-Green**, criar os serviços necessários (ativo e preview), aplicar as configurações e explorar o monitoramento via **dashboard** e **CLI do `kubectl argo rollouts`**. O foco é habilitar implantações seguras com controle manual de promoção entre versões.

---

# Verificação da Instalação do Argo Rollouts  
Após a instalação do manifest YAML, diversos recursos foram criados no cluster:  
- **CRDs** (Custom Resource Definitions)  
- **ConfigMaps**, **Secrets**, **Services**, **Deployments** internos do Rollouts  
- **RBAC** (Roles, ClusterRoles, ServiceAccounts) para segurança  

### Verificando os CRDs  
```bash
kubectl get crds
```  
Retorna apenas os CRDs do Argo (no cluster limpo):  
```  
analysisruns.argoproj.io  
analysistemplates.argoproj.io  
clusteranalysistemplates.argoproj.io  
experiments.argoproj.io  
rollouts.argoproj.io  
```  
- **API Group**: `argoproj.io`  
- **Kinds principais**: `Rollout`, `AnalysisTemplate`, `Experiment`  
- Disponíveis também via **Lens** → *Custom Resources*  

> **Importante**: Esses CRDs **não são nativos do Kubernetes**. Só existem após a instalação do Argo Rollouts.

---

# Adaptando o Deployment para Rollout (Blue-Green)  

### Mudanças Obrigatórias no Manifesto  
1. **Alterar `apiVersion` e `kind`**:  
   ```yaml
   apiVersion: argoproj.io/v1alpha1
   kind: Rollout
   ```  
   > Só funciona se o CRD estiver instalado.

2. **Remover ou comentar a estratégia nativa** (`RollingUpdate`)  
   ```yaml
   # strategy:
   #   rollingUpdate:
   #     maxSurge: 25%
   #     maxUnavailable: 25%
   ```  

3. **Adicionar `revisionHistoryLimit`** (boa prática):  
   ```yaml
   revisionHistoryLimit: 5
   ```  
   → Limita o histórico de ReplicaSets para 5 revisões (padrão do K8s é 10).

4. **Definir a estratégia Blue-Green**:  
   ```yaml
   strategy:
     blueGreen:
       activeService: widget-server-svc          # Serviço em produção
       previewService: widget-server-svc-preview # Serviço de teste
       autoPromotionEnabled: false               # Promoção manual
   ```  

---

# Serviços Necessários para Blue-Green  
Blue-Green exige **dois Services**:  
- **Active Service**: recebe tráfego real (`widget-server-svc`)  
- **Preview Service**: usado para validação da nova versão (`widget-server-svc-preview`)  

### Criação do Preview Service  
```yaml
apiVersion: v1
kind: Service
metadata:
  name: widget-server-svc-preview
  namespace: widget
spec:
  selector:
    app: widget-server
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
  type: ClusterIP
```  
> Mesmos seletores do serviço ativo → aponta para os mesmos pods.

---

# Aplicação dos Manifestos  
Passos executados:  
1. Criar namespace:  
   ```bash
   kubectl create namespace widget
   ```  
2. Aplicar ConfigMap, Secret e Service ativo:  
   ```bash
   kubectl apply -n widget -f configmap.yaml
   kubectl apply -n widget -f secret.yaml
   kubectl apply -n widget -f service-active.yaml
   ```  
3. Aplicar Preview Service e Rollout:  
   ```bash
   kubectl apply -n widget -f service-preview.yaml
   kubectl apply -n widget -f rollout.yaml
   ```  

> **Erro comum**: esquecer o campo `strategy.blueGreen` → Rollout rejeita com erro de validação.

---

# Monitoramento e Controle do Rollout  

### 1. **Dashboard Web (UI)**  
- Instalado automaticamente com o Argo Rollouts  
- Acessível via:  
  ```bash
  kubectl argo rollouts dashboard -n argo-rollouts
  ```  
  → Abre em `http://localhost:3100`  
- Mostra:  
  - Status do Rollout (Healthy, Degraded)  
  - Versão ativa (ex: v3)  
  - Botões de **Promote** e **Rollback**  
  - Histórico visual de revisões  

### 2. **CLI com `kubectl argo rollouts`**  
Comandos úteis:  
```bash
# Ver status do rollout
kubectl argo rollouts get rollout widget-server-deployment -n widget

# Promover manualmente
kubectl argo rollouts promote widget-server-deployment -n widget

# Fazer rollback
kubectl argo rollouts undo widget-server-deployment -n widget
```  
> **Dica de segurança**: evitar acesso direto ao cluster. Integrar com Backstage, Portainer ou portais internos.

---

# Comportamento Observado  
- Rollout substitui o **Deployment** tradicional  
- Cria **ReplicaSets** para cada versão (ex: v2 → v3)  
- Pods da nova versão são escalados **após promoção manual**  
- Tráfego só vai para o **Active Service** até a promoção  
- Preview Service permite testes sem impacto no cliente  

> **Teste prático**: alterar a imagem para `v3`, aplicar → nova versão fica em *preview* até o `promote`.

---

# Conclusão  
A aula demonstrou com sucesso a **migração de um Deployment nativo para um Rollout com Blue-Green**, incluindo:  
- Adaptação do manifesto com `apiVersion: argoproj.io/v1alpha1` e `kind: Rollout`  
- Configuração de dois Services (ativo e preview)  
- Uso de `autoPromotionEnabled: false` para controle manual  
- Monitoramento via **dashboard web** e **CLI (`kubectl argo rollouts`)**  
- Boas práticas: `revisionHistoryLimit`, versionamento de imagens, segurança de acesso  

O ambiente está pronto para a próxima aula, onde será testada a **criação de uma nova versão, promoção manual e rollback**, além da introdução ao **Canary Deployment**.