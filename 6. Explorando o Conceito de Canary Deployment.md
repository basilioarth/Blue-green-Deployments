# Introdução  
A aula explora na prática o **Canary Deployment** com **Argo Rollouts**, mostrando como configurar a estratégia `canary` no manifesto, definir **pesos de tráfego** (`setWeight`) e **pausas** (`pause`) em etapas, e como o Argo controla o rollout progressivo com promoção manual ou automática. O professor destaca a diferença em relação ao Blue-Green (uso de um único Service) e prepara o ambiente com 10 pods para exemplos mais realistas na próxima aula.

---

# Diferença entre Blue-Green e Canary  
| Característica | **Blue-Green** | **Canary** |
|----------------|----------------|-----------|
| **Serviços** | 2 (ativo + preview) | 1 (único Service) |
| **Tráfego** | 100% em uma versão por vez | Dividido por % entre versões |
| **Preview** | Versão de teste isolada | Pods novos recebem % do tráfego real |
| **Risco** | Baixo (teste antes de ativar) | Controlado (exposição gradual) |
| **Uso comum** | Produção (com promoção manual) | Produção e staging (progressivo) |

> **Dica prática**:  
> - Em **produção**: Blue-Green com `autoPromotionEnabled: false`  
> - Em **staging**: Blue-Green com `autoPromotionEnabled: true` ou Canary com pausas curtas

---

# Configurando a Estratégia Canary no Rollout  

### 1. Alterar a estratégia no manifesto  
```yaml
strategy:
  canary:
    steps:
      - setWeight: 20
        pause: {}
      - setWeight: 30
        pause:
          duration: 60 # segundos
      - setWeight: 50
        pause: {}
      - setWeight: 100
        pause: {}
```

### 2. Explicação dos Campos  
- **`setWeight: X`**  
  → Define o % do tráfego que vai para a **nova versão**  
- **`pause: {}`**  
  → Pausa **indefinida** → **exige promoção manual**  
- **`pause: { duration: 60 }`**  
  → Pausa **automática** por 60 segundos → segue para o próximo step  

> **Regra de ouro**:  
> - Último step com `pause: {}` → **palavra final do operador**  
> - Sem `pause`, ou com `duration`, → **100% automático**

---

# Comportamento do Canary com Poucos Pods  
Exemplo com **2 pods** e `setWeight: 20`:  
- Argo tenta alocar ~20% → **1 pod novo**  
- Cálculo imperfeito → peso real pode ser **33%** ou **50%**  
- **Problema**: matemática imprecisa com poucos pods  

**Solução**:  
→ Usar **10+ pods** para exemplos realistas (ajustado ao final da aula)

---

# Monitoramento do Canary  

### Via Dashboard (`kubectl argo rollouts dashboard`)  
- Mostra:  
  - Peso desejado × peso atual  
  - Pods antigos vs. novos  
  - Etapa atual (pausada ou em progresso)  
  - Botão **Promote** para avançar manualmente  

### Via CLI  
```bash
kubectl argo rollouts get rollout widget-server-deployment -n widget
```
Saída exemplo:
```
Name:         widget-server-deployment
Namespace:    widget
Strategy:     Canary
Step:         1/4
SetWeight:    20%
ActualWeight: 33%
Status:       Paused
```

```bash
# Promover manualmente
kubectl argo rollouts promote widget-server-deployment -n widget
```

---

# Fluxo Prático Demonstrado  
1. **Reverteu imagem para `v3`** (evitar build longo)  
2. **Aplicou manifesto com estratégia Canary**  
3. **Argo criou 1 pod novo** (20% do tráfego)  
4. **Service único** passou a rotear ~33% para o pod novo  
5. **Promoveu manualmente** → subiu para 30% → esperou 60s  
6. **Promoveu novamente** → 100% (sem mais steps)  
7. **Aumentou réplicas para 10** (preparação para próxima aula)  
   ```yaml
   replicas: 10
   ```

> **Observação**:  
> Alterar apenas `replicas` **não dispara Canary**  
> → Só troca de **imagem** (tag) ativa o rollout progressivo

---

# Boas Práticas no Canary  
- **Steps crescentes**: 10% → 25% → 50% → 100%  
- **Pausas curtas com `duration`** em staging  
- **Último step com `pause: {}`** em produção  
- **Mínimo 10 pods** para pesos precisos  
- **Monitorar métricas** (latência, erro) antes de promover  
- **Integrar com ferramentas de observabilidade** (Prometheus, New Relic)

---

# Conclusão  
A aula demonstrou com clareza o funcionamento do **Canary Deployment no Argo Rollouts**, destacando:  
- Configuração simples com `strategy.canary.steps`  
- Controle fino via `setWeight` e `pause`  
- Uso de **um único Service** (diferente do Blue-Green)  
- Necessidade de **promoção manual** em pausas indefinidas  
- Limitações com poucos pods e preparação para exemplos robustos  

O ambiente agora tem **10 réplicas** e está pronto para a próxima aula, onde serão testados **rollouts com múltiplos steps, promoção gradual, análise de métricas e rollback em cenários reais de produção**. O Canary se mostra uma estratégia poderosa para **reduzir riscos com exposição controlada**.