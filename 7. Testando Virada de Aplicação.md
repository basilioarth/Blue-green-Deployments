# Introdução  
A aula finaliza o módulo de **Argo Rollouts** com um **Canary Deployment realista** usando **10 réplicas**, configura **steps progressivos com pausas automáticas e manuais**, demonstra a **precisão do controle de tráfego por peso**, explora a opção de **`canaryService` + `stableService`**, esclarece **limitações e boas práticas**, e reforça a **abstração poderosa** que o Argo oferece sobre CRDs. O professor encerra com uma visão geral do aprendizado e dicas para aprofundamento em infraestrutura.

---

# Configuração Final do Canary com 10 Réplicas  

### Estrutura de `steps` aplicada  
```yaml
strategy:
  canary:
    steps:
      - setWeight: 20
        pause: {}
      - setWeight: 40
        pause:
          duration: 30
      - setWeight: 60
        pause:
          duration: 20
      - setWeight: 80
        pause:
          duration: 10
      - setWeight: 90
        pause: {}
```

### Fluxo observado no dashboard  
| Step | Peso Desejado | Peso Real | Réplicas V3 | Réplicas V4 | Ação |
|------|----------------|-----------|-------------|-------------|------|
| 1    | 20%            | 20%       | 8           | 2           | Manual promote |
| 2    | 40%            | 40%       | 6           | 4           | Após 30s |
| 3    | 60%            | 60%       | 4           | 6           | Após 20s |
| 4    | 80%            | 80%       | 2           | 8           | Após 10s |
| 5    | 90%            | 90%       | 1           | 9           | Pausa manual |
| 6    | 100%           | 100%      | 0           | 10          | Promote final |

> **Peso real acompanhou o desejado com precisão** → graças às **10 réplicas**

---

# Conceitos Avançados: `stableService` e `canaryService`  

### Objetivo  
Separar pods por versão em **dois Services**, mesmo no Canary.

```yaml
strategy:
  canary:
    stableService: widget-server-svc          # Produção (versão estável)
    canaryService: widget-server-svc-preview  # Nova versão
    steps: [...]
```

### Comportamento  
| Serviço | IPs | Versão |
|---------|-----|--------|
| `widget-server-svc` | 8 → 6 → 4 → 2 → 1 → 0 | V3 (antiga) |
| `widget-server-svc-preview` | 2 → 4 → 6 → 8 → 9 → 10 | V4 (nova) |

> **Vantagem**:  
> - Cliente pode rotear tráfego **explicitamente** para um ou outro  
> - Útil para testes controlados via cliente ou proxy  

> **Desvantagem**:  
> - Cliente precisa **gerenciar duas URLs**  
> - **Não é comum** em produção (complexidade desnecessária)

---

# Limitações e Boas Práticas  

| Tema | Detalhe |
|------|--------|
| **Múltiplas estratégias** | **Não permitido** → `blueGreen` e `canary` no mesmo Rollout → erro de validação |
| **Sessão do usuário** | Argo **não gerencia** stickiness → refresh pode alternar versão |
| **Soluções para stickiness** |  
| → `Sticky Sessions` (cookies)  
| → `Consistent Hashing` (header/IP)  
| → Configurar em **Ingress**, **NGINX**, **ALB**, **API Gateway** |
| **Liberação por região/IP** | Fora do escopo do Argo → usar proxy reverso |
| **Rollback** | Mesmo comportamento do Blue-Green → `kubectl argo rollouts undo` |

---

# Comparação Final: Blue-Green vs Canary  

| Critério | **Blue-Green** | **Canary** |
|---------|----------------|-----------|
| **Serviços** | 2 (ativo + preview) | 1 (ou 2 com `canaryService`) |
| **Tráfego** | 100% em uma versão | % gradual |
| **Teste** | Preview isolado | Tráfego real parcial |
| **Risco** | Mínimo | Controlado |
| **Complexidade** | Baixa | Média (steps, pausas) |
| **Uso ideal** | Produção crítica | Lançamentos graduais |

---

# Revisão Geral do Aprendizado  

1. **Argo Rollouts** → CRD que **estende a API do Kubernetes**  
2. **Instalação simples** → `kubectl apply -f rollouts.yaml`  
3. **Substitui `Deployment`** → usa `kind: Rollout`  
4. **Duas estratégias principais**:  
   - `blueGreen` → segurança total (preview isolado)  
   - `canary` → exposição gradual (tráfego por %)  
5. **Controle via**:  
   - `kubectl argo rollouts` (CLI)  
   - Dashboard web (`localhost:3100`)  
6. **Automatização segura** com:  
   - `pause: { duration: X }`  
   - `pause: {}` → aprovação manual  
7. **Observabilidade é essencial** → Prometheus, New Relic, etc.  
8. **Rollback instantâneo** → `undo` volta à revisão anterior  

---

# Conclusão  
A aula consolidou o **domínio prático do Argo Rollouts** com um **Canary Deployment robusto**, demonstrou **controle preciso de tráfego com 10 réplicas**, explorou a **opção avançada de `canaryService`**, e reforçou que o **Argo abstrai complexidade** via CRDs, permitindo implantações seguras sem contato direto com mecanismos nativos do Kubernetes.  

**Dica final do professor**:  
> Aprofunde-se em **Ingress**, **Gateway API**, **NGINX**, **ALB**, **Feature Flags** e **Observabilidade** para evoluir de deployments seguros para **liberações controladas, regionais e com stickiness**.